<div class="container-fluid px-4 py-4">

  <!-- Header Section -->
  <div class="row align-items-center mb-5">
    <div class="col-lg-8">
      <div class="page-header">
        <div class="d-flex align-items-center mb-2">
          <div class="icon-container bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="bx bx-list-ul fs-3 text-primary"></i>
          </div>
          <div>
            <h1 class="h3 fw-bold mb-1 text-dark">Gestor de Formularios</h1>
            <p class="text-muted mb-0 fs-6">Administra y crea formularios dinámicos para tu aplicación</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 text-lg-end">
      <button class="btn btn-primary btn-lg px-4 py-2 shadow-sm" (click)="openCreateModal()"
        [disabled]="(loading$ | async)" style="border-radius: 12px;">
        <i class="bx bx-plus fs-5 me-2"></i>
        <span class="fw-semibold">Nuevo Formulario</span>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading$ | async" class="d-flex flex-column align-items-center justify-content-center"
    style="min-height: 300px;">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 class="text-muted fw-normal">Cargando formularios...</h5>
    <p class="text-muted small mb-0">Por favor espera un momento</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="(forms$ | async) as forms">
    <div *ngIf="forms.length === 0 && !(loading$ | async)" class="empty-state text-center py-5">
      <div class="empty-state-container">
        <div class="empty-icon bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-4"
          style="width: 120px; height: 120px;">
          <i class="bx bx-inbox display-1 text-muted"></i>
        </div>
        <h3 class="fw-bold text-dark mb-3">No hay formularios creados</h3>
        <p class="text-muted mb-4 fs-6 mx-auto" style="max-width: 400px;">
          Comienza creando tu primer formulario dinámico para recopilar información de manera organizada
        </p>
        <button class="btn btn-primary btn-lg px-4 py-3 shadow-sm" (click)="openCreateModal()"
          style="border-radius: 12px;">
          <i class="bx bx-plus fs-5 me-2"></i>
          <span class="fw-semibold">Crear Mi Primer Formulario</span>
        </button>
      </div>
    </div>

    <!-- Listado -->
    <div class="row g-4" *ngIf="forms.length > 0">
      <div class="col-md-6 col-lg-4" *ngFor="let form of forms">

        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0 fw-bold">{{ form.name }}</h5>
              <span class="badge bg-secondary">{{ form.code }}</span>
            </div>

            <p class="text-muted small">{{ form.description || 'Sin descripción' }}</p>

            <div class="d-flex flex-column gap-2 p-3 rounded border bg-light small shadow-sm">

              <div class="d-flex align-items-center">
                <span class="fw-semibold text-secondary me-2">
                  <i class="bi bi-upc-scan"></i> Versión:
                </span>
                <span class="text-dark fw-bold">v{{ form.version }}</span>
              </div>

              <div class="d-flex align-items-center">
                <span class="fw-semibold text-secondary me-2">
                  <i class="bi bi-list-ol"></i> Orden:
                </span>
                <span class="text-dark">{{ form.display_order }}</span>
              </div>

              <div class="d-flex align-items-center">
                <span class="fw-semibold text-secondary me-2">
                  <i class="bi bi-check-circle"></i> Estado:
                </span>
                <span class="badge rounded-pill px-3 py-2"
                  [ngClass]="form.is_active ? 'bg-success-subtle text-success border border-success' : 'bg-danger-subtle text-danger border border-danger'">
                  {{ form.is_active ? 'Activo' : 'Inactivo' }}
                </span>
              </div>
            </div>
            <br>
            <div class="d-flex gap-2">

              <!-- Ver -->
              <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1 shadow-sm"
                (click)="viewFormDetails(form.id!)" [disabled]="!form">
                <i class="bi bi-eye"></i>
                <span>Ver</span>
              </button>

              <!-- Editar -->
              <button class="btn btn-outline-warning btn-sm d-flex align-items-center gap-1 shadow-sm"
                (click)="openEditModal(form)" [disabled]="!form">
                <i class="bi bi-pencil-square"></i>
                <span>Editar</span>
              </button>

              <!-- Eliminar -->
              <button class="btn btn-outline-danger btn-sm d-flex align-items-center gap-1 shadow-sm"
                (click)="deleteForm(form.id!)" [disabled]="!form || !form.id">
                <i class="bi bi-trash"></i>
                <span>Eliminar</span>
              </button>

            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Modal Crear/Editar -->
<div class="modal fade show d-block bg-dark bg-opacity-50" tabindex="-1" role="dialog" *ngIf="showFormModal"
  (click)="closeFormModal()">
  <div class="modal-dialog modal-xl modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content shadow-lg rounded-3">

      <!-- HEADER -->
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title d-flex align-items-center gap-2 fw-semibold">
          <i [ngClass]="isAddFieldMode ? 'bi bi-plus-square text-success' : (isEditMode ? 'bi bi-pencil-square text-warning' : 'bi bi-plus-circle text-primary')"></i>
          {{ isAddFieldMode ? 'Agregar Campo al Formulario' : (isEditMode ? 'Editar Formulario' : 'Crear Formulario') }}
        </h5>
        <button type="button" class="btn-close" (click)="closeFormModal()"></button>
      </div>

      <form (ngSubmit)="isAddFieldMode ? onSubmitNewField() : onSubmit()" #formForm="ngForm">

        <div class="modal-body">

          <!-- MODO: Crear/Editar Formulario -->
          <div *ngIf="!isAddFieldMode">
            <!-- CARD: Información del Formulario -->
            <div class="card shadow-sm mb-4">
              <div
                class="card-header bg-primary bg-opacity-10 text-primary fw-bold small d-flex align-items-center gap-2">
                <i class="bi bi-file-earmark-text"></i> Información del Formulario
              </div>

              <div class="card-body">
                <div class="row g-3">

                  <div class="col-md-6">
                    <label class="form-label fw-medium small">Nombre *</label>
                    <input class="form-control form-control-sm" required [(ngModel)]="newForm.name" name="name"
                      placeholder="Ej: Formulario de Contacto">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-medium small">Código *</label>
                    <input class="form-control form-control-sm" required [(ngModel)]="newForm.code" name="code"
                      [disabled]="isEditMode" placeholder="Ej: contact_form">
                    <small class="text-muted small">Solo letras, números, guiones y _</small>
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-medium small">Descripción</label>
                    <textarea class="form-control form-control-sm" rows="2" [(ngModel)]="newForm.description"
                      name="description" placeholder="Describe el propósito del formulario"></textarea>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-medium small">Versión *</label>
                    <input class="form-control form-control-sm" required [(ngModel)]="newForm.version" name="version"
                      placeholder="Ej: 1.0">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-medium small">Orden de Visualización</label>
                    <input type="number" class="form-control form-control-sm" [(ngModel)]="newForm.display_order"
                      name="display_order" min="0">
                  </div>

                  <div class="col-12">
                    <div class="form-check form-switch small">
                      <input class="form-check-input" type="checkbox" [(ngModel)]="newForm.is_active" name="is_active"
                        id="formActive">
                      <label class="form-check-label" for="formActive">Formulario Activo</label>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <!-- MODO: Agregar Campo -->
          <div *ngIf="isAddFieldMode">
            <!-- Info del formulario al que se añade -->
            <div class="alert alert-info py-2 small mb-3" *ngIf="targetFormForNewField">
              <i class="bi bi-info-circle"></i>
              Agregando campo al formulario: <strong>{{ targetFormForNewField.name }}</strong> ({{ targetFormForNewField.code }})
            </div>

            <!-- CARD: Información del Campo -->
            <div class="card shadow-sm mb-4">
              <div
                class="card-header bg-success bg-opacity-10 text-success fw-bold small d-flex align-items-center gap-2">
                <i class="bi bi-plus-square"></i> Información del Campo
              </div>

              <div class="card-body">
                <div class="row g-3">

                  <div class="col-md-6">
                    <label class="form-label fw-medium small">Etiqueta *</label>
                    <input class="form-control form-control-sm" required [(ngModel)]="newFormFile.label"
                      name="field_label" placeholder="Ej: Nombre completo">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-medium small">Código *</label>
                    <input class="form-control form-control-sm" required [(ngModel)]="newFormFile.field_code"
                      name="field_code" placeholder="Ej: full_name">
                    <small class="text-muted small">Solo letras, números, guiones y _</small>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-medium small">Tipo *</label>
                    <select class="form-select form-select-sm" required [(ngModel)]="newFormFile.type" name="field_type">
                      <option value="">Seleccionar tipo</option>
                      <option value="text">Texto</option>
                      <option value="email">Email</option>
                      <option value="number">Número</option>
                      <option value="tel">Teléfono</option>
                      <option value="password">Contraseña</option>
                      <option value="textarea">Área de Texto</option>
                      <option value="select">Select</option>
                      <option value="radio">Radio</option>
                      <option value="checkbox">Checkbox</option>
                      <option value="date">Fecha</option>
                      <option value="time">Hora</option>
                      <option value="file">Archivo</option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-medium small">Orden</label>
                    <input type="number" class="form-control form-control-sm" [(ngModel)]="newFormFile.field_order"
                      name="field_order" min="0" placeholder="Orden del campo">
                  </div>

                  <div class="col-12" *ngIf="['select','radio','checkbox'].includes(newFormFile.type)">
                    <label class="form-label fw-medium small">Opciones</label>
                    <textarea class="form-control form-control-sm" rows="3" [(ngModel)]="optionsText" name="options_text"
                      placeholder="Opción 1&#10;Opción 2&#10;Opción 3"></textarea>
                    <small class="text-muted small">Una opción por línea</small>
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-medium small">Validación (JSON)</label>
                    <textarea class="form-control form-control-sm" rows="2" [(ngModel)]="validationRulesText"
                      name="validation_rules_text" placeholder='{"minLength": 3, "maxLength": 50}'></textarea>
                    <small class="text-muted small">Reglas de validación en formato JSON</small>
                  </div>

                  <div class="col-md-6">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" [(ngModel)]="newFormFile.required"
                        name="field_required" id="fieldRequired">
                      <label for="fieldRequired" class="form-check-label small">Campo requerido</label>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" [(ngModel)]="newFormFile.is_active"
                        name="field_active" id="fieldActive">
                      <label for="fieldActive" class="form-check-label small">Campo activo</label>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- FOOTER -->
        <div class="modal-footer">
          <small class="text-muted me-auto" *ngIf="!isAddFieldMode && isEditMode && editFormFiles.length > 0">
            <i class="bi bi-info-circle"></i> {{ editFormFiles.length }} campos configurados
          </small>

          <small class="text-muted me-auto" *ngIf="isAddFieldMode && targetFormForNewField">
            <i class="bi bi-info-circle"></i> Formulario: {{ targetFormForNewField.name }}
          </small>

          <button class="btn btn-outline-secondary" (click)="closeFormModal()">Cancelar</button>
          <button class="btn" 
                  [ngClass]="isAddFieldMode ? 'btn-success' : 'btn-primary'" 
                  type="submit" 
                  [disabled]="!formForm.valid">
            <i [ngClass]="isAddFieldMode ? 'bi bi-plus-circle' : (isEditMode ? 'bi bi-check-circle' : 'bi bi-plus-circle')"></i>
            {{ isAddFieldMode ? 'Agregar Campo' : (isEditMode ? 'Actualizar' : 'Crear') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Modal Detalles del Formulario -->
<div class="modal fade show d-block" tabindex="-1" role="dialog" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-dialog modal-xl" (click)="$event.stopPropagation()">
    <div class="modal-content border-0 shadow-lg rounded-3">

      <!-- Header -->
      <div class="modal-header bg-gradient-primary text-white d-flex align-items-center">
        <h5 class="modal-title d-flex align-items-center gap-2 m-0 fs-5 fw-bold">
          <i class="bx bx-show fs-4"></i> Detalles del Formulario
        </h5>
        <button type="button" class="btn btn-light btn-sm rounded-circle" (click)="closeDetailsModal()">
          X
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body py-4 px-4" *ngIf="selectedForm; else loadingDetails">

        <!-- Info General -->
        <div class="card border-0 shadow-sm mb-4 rounded-3">
          <div class="card-header bg-light d-flex align-items-center">
            <h6 class="m-0 fw-bold">
              <i class="bx bx-info-circle text-primary me-1"></i> Información General
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-4">

              <!-- Nombre y descripción -->
              <div class="col-md-6">
                <h4 class="fw-bold text-primary mb-1">{{ selectedForm.name }}</h4>
                <span class="badge bg-dark mb-2">{{ selectedForm.code }}</span>
                <p class="text-muted small">{{ selectedForm.description || 'Sin descripción disponible' }}</p>
              </div>

              <!-- Datos -->
              <div class="col-md-6">
                <table class="table table-sm table-borderless m-0">
                  <tr>
                    <td class="fw-semibold">Versión:</td>
                    <td>v{{ selectedForm.version }}</td>
                  </tr>
                  <tr>
                    <td class="fw-semibold">Creado por:</td>
                    <td>ID {{ selectedForm.created_by }}</td>
                  </tr>
                  <tr>
                    <td class="fw-semibold">Orden:</td>
                    <td>{{ selectedForm.display_order }}</td>
                  </tr>
                  <tr>
                    <td class="fw-semibold">Estado:</td>
                    <td>
                      <span class="badge px-2 py-1" [class.bg-success]="selectedForm.is_active"
                        [class.bg-danger]="!selectedForm.is_active">
                        {{ selectedForm.is_active ? 'Activo' : 'Inactivo' }}
                      </span>
                    </td>
                  </tr>
                </table>
              </div>

            </div>
          </div>
        </div>

        <!-- Campos -->
        <div class="card border-0 shadow-sm rounded-3">
          <div class="card-header bg-light d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <h6 class="m-0 fw-bold">
                <i class="bx bx-list-ul text-success me-1"></i> Campos del Formulario
              </h6>
              <span class="badge bg-primary ms-2">{{ selectedFormFiles.length }}</span>
            </div>
            <button class="btn btn-success btn-sm" (click)="handleAddField()" *ngIf="selectedFormFiles.length > 0">
              <i class="bx bx-plus"></i> Agregar Campo
            </button>
          </div>
          <div class="card-body">

            <!-- Sin campos -->
            <div *ngIf="selectedFormFiles.length === 0" class="text-center py-5 text-muted">
              <i class="bx bx-folder-open fs-1"></i>
              <p class="mt-2 fw-semibold">No hay campos configurados</p>
              <button class="btn btn-primary btn-sm mt-1" (click)="handleAddField()">
                <i class="bx bx-plus"></i> Agregar Campo
              </button>
            </div>

            <!-- Lista -->
            <div *ngIf="selectedFormFiles.length > 0">
              <div class="row g-3">
                <div class="col-md-6" *ngFor="let field of selectedFormFiles">

                  <div class="card h-100 border-0 shadow-sm rounded-3">
                    <div class="card-body p-3">

                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold m-0">{{ field.label }}</h6>
                        <span class="badge bg-info">{{ field.type }}</span>
                      </div>

                      <p class="text-muted small mb-2"><code>{{ field.field_code }}</code></p>

                      <div class="small">
                        <div class="d-flex justify-content-between text-muted mb-1">
                          <span>Orden: <strong>{{ field.field_order }}</strong></span>
                          <span class="badge" [class.bg-success]="field.is_active"
                            [class.bg-secondary]="!field.is_active">
                            {{ field.is_active ? 'Activo' : 'Inactivo' }}
                          </span>
                        </div>

                        <div *ngIf="field.required" class="mt-1">
                          <span class="badge bg-warning text-dark">
                            <i class="bx bx-asterisk"></i> Requerido
                          </span>
                        </div>

                        <div class="mt-2" *ngIf="field.options?.length">
                          <small class="text-muted">Opciones:</small>
                          <div class="mt-1">
                            <span *ngFor="let option of field.options.slice(0,3)" class="badge bg-light text-dark me-1">
                              {{ option }}
                            </span>
                            <span *ngIf="field.options.length > 3" class="text-muted small">
                              +{{ field.options.length - 3 }} más
                            </span>
                          </div>
                        </div>

                        <div *ngIf="field.validation_rules?.length" class="mt-2">
                          <small class="text-muted d-flex align-items-center">
                            <i class="bx bx-shield me-1"></i> Con validaciones
                          </small>
                        </div>

                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>

          </div>
        </div>

      </div>

      <!-- Loading -->
      <ng-template #loadingDetails>
        <div class="modal-body py-5 text-center">
          <div class="spinner-border text-primary mb-2"></div>
          <p class="text-muted m-0">Cargando detalles...</p>
        </div>
      </ng-template>

      <!-- Footer -->
      <div class="modal-footer d-flex justify-content-between p-3 border-0">
        <button class="btn btn-outline-secondary" (click)="closeDetailsModal()">
          <i class="bx bx-x"></i> Cerrar
        </button>
      </div>

    </div>
  </div>
</div>